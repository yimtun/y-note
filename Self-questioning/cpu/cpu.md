# 1 cpu  load average   



```
cpu 平均负载
```



```
top / uptime
```



```
平均负载是指    单位时间内 系统 的 平均活跃进程数


平均负载是指    单位时间内 系统处于可运行状态和 不可中断状态的  平均进程数，也就是 平均活跃进程数
```





## 可运行状态的进程



```
是指正在使用 CPU 或者正在等待 CPU 的进程
也就是我们常用 ps 命令看到的 处于 R 状态（Running 或 Runnable）的进程。
```



### 不可中断状态的进程

```
是正处于内核态关键流程中的进程，并且这些流程是不可打断的，
比如最常见的是等待硬件设备的 I/O 响应，
也就是我们在 ps 命令中看到的 D 状态（Uninterruptible Sleep，也称为 Disk Sleep）的进程。
```



### 简单理解

```
单位时间内的活跃进程数的平均值
```



### 复杂理解



```
单位时间内 指数衰减平均
```









# 2 CPU 使用率







CPU使用率，是单位时间内 CPU 繁忙情况的统计







### 开机以来的平均 CPU 使用率



```
ps  进程的整个生命周期
CPU 使用率，就是除了空闲时间外的其他时间  占总 CPU 时间的百分比
```



![img](https://static001.geekbang.org/resource/image/3e/09/3edcc7f908c7c1ddba4bbcccc0277c09.png?wh=312*78)















##  最近一段时间内的 CPU使用率



![img](https://static001.geekbang.org/resource/image/84/5a/8408bb45922afb2db09629a9a7eb1d5a.png?wh=569*85)







```
top 默认计算的时间间隔 是3秒
性能工具一般都会取间隔一段时间（比如 3 秒）的两次值，作差后，再计算出这段时间内的平均 CPU 使用率
```

















```
CPU 使用率是单位时间内 CPU 使用情况的统计
```





## jiffy



```
CPU有一个基本时间度量单位叫做jiffy，这是一个很短的时间，具体时长多少取决与硬件
```



```
内核时钟的频率是由CONFIG_HZ决定的，以前默认是100HZ，现在内核默认是250HZ。
而1个jiffy是1个时钟滴答，时间间隔是有CONFIG_HZ决定的，频率是250HZ，
也就是周期为4ms。每4ms，增加一个时钟滴答，也即jiffies++。




```





### 节拍器



```
Linux 作为一个多任务操作系统，将每个 CPU 的时间划分为很短的时间片，再通过调度器轮流分配给各个任务使用
```



```
为了维护 CPU 时间，Linux 通过事先定义的节拍率（内核中表示为 HZ），触发时间中断，
并使用全局变量 Jiffies 记录了开机以来的节拍数。
每发生一次时间中断，Jiffies 的值就加 1。

节拍率 HZ 是内核的可配选项，可以设置为 100、250、1000 等。
不同的系统可能设置不同数值，可以通过查询 /boot/config 内核选项来查看它的配置值。


[root@11-1-0-250 ~]# grep 'CONFIG_HZ=' /boot/config-$(uname -r)
CONFIG_HZ=1000

这里节拍率设置成了 1000，也就是每秒钟触发 1000 次时间中断


为程序分配cpu资源也就是 也就是为程序分配cpu时间
这里cpu时间分配的最小单位是  1/1000秒   即 1毫秒

所以cpu 资源  1核 = 1000毫核（m）
一个服务器有4个核心  cpu 资源就为  4000毫核（m）





用户空间节拍率 USER_HZ

它总是固定为 100，也就是 1/100 秒  【也就是  10毫秒 10ms（1/100 秒）】 （每秒钟触发 100 次时间中断）   
用户空间程序并不需要关心内核中 HZ 被设置成了多少，因为它看到的总是固定值 USER_HZ。

```





## 不同场景下的cpu时间



### user（通常缩写为 us），

代表用户态 CPU 时间。注意，它不包括下面的 nice 时间，但包括了 guest 时间。

### nice（通常缩写为 ni），

代表低优先级用户态 CPU 时间，也就是进程的 nice 值被调整为 1-19 之间时的 CPU 时间。这里注意，nice 可取值范围是 -20 到 19，数值越大，优先级反而越低。

### system（通常缩写为 sys），

代表内核态 CPU 时间。



### idle（通常缩写为 id），代表空闲时间。注意，它不包括等待 I/O 的时间（iowait）。



### iowait（通常缩写为 wa），



代表等待 I/O 的 CPU 时间。



### irq（通常缩写为 hi），代表处理硬中断的 CPU 时间。



### softirq（通常缩写为 si），代表处理软中断的 CPU 时间。



### steal（通常缩写为 st），



代表当系统运行在虚拟机中的时候，被其他虚拟机占用的 CPU 时间。



### guest（通常缩写为 guest），



代表通过虚拟化运行其他操作系统的时间，也就是运行虚拟机的 CPU 时间。



### guest_nice（通常缩写为 gnice），



代表以低优先级运行虚拟机的时间。



```
CPU 使用率，是单位时间内 CPU 繁忙情况的统计，跟平均负载并不一定完全对应
```





#  cpu 负载 和cpu 使用率的关系







```
CPU使用率，跟平均负载并不一定完全对应。


比如：

1 CPU 密集型进程， 使用大量 CPU 会导致平均负载升高，此时这两者是一致的；
2 I/O 密集型进程，等待 I/O 也会导致平均负载升高，但 CPU 使用率不一定很高；
3 大量等待 CPU 的进程调度也会导致平均负载升高，此时的 CPU 使用率也会比较高。
```



